---
title: Simulation Results
date: "`r date`"
output:
  pdf_document
params:
  boxplot: TRUE
  bootstrap: TRUE
  first.step: TRUE
  ci: TRUE
---

```{r compile, eval=FALSE, echo=FALSE}
# render('results-template.Rmd', output_format = "pdf_document")
```


```{r include=FALSE, eval=TRUE}
library(knitr)
library(listr)
opts_chunk$set(echo=FALSE, comment='')

methods <- c("proposed", "cgm", "vdg")
methods.detected <- hutils::if_else(c(proposed.method, compare.to.cgm, compare.to.vdg),
                                    methods,
                                    "") |> str_subset(".")
if(!"proposed" %in% methods.detected){
  target.names <- paste0(file.param.name)
  # target.folders <- str_subset(list.files(getwd()), pattern=paste0(target.names) )
  message(list.files())
  target.folders <- grep(target.names, list.files(), value=TRUE)
  if(length(target.folders)==0) stop('No target folders found.')
  # target.folders <- list.files(pattern=fixed(target.names) )
  comparison.found <- FALSE
  for(folder in target.folders){
    candidate <- paste0(target.folders[folder], '/sim-data.RData')
    load(candidate)
    if(env_get(output, 'proposed.method')){
      results.hist <- env_get(output, 'results.hist')
      comparison.found <- TRUE
      paste0("No comparison to the proposed method was completed in the provided simulation. A comparison with the same parameters was found at ", candidate, " and will be used for comparison in this report.") |> message()
      break
    }
  }
}
```

```{r eval=!is.null(note), results='asis'}
cat(" **Note**: ", note)
```

## Simulation Setup

This simulation is performed with $n=`r n`$ and $d=`r d`$, using the 2-d lattice as the underlying graph. $s=`r s`$ parameters are set to be nonzero, and the beta parameter is chosen to be $\beta=`r beta`$. The attached results are for a `r n.sim`-replication simulation. The true values of the parameter vector $\theta$ are

```{r}
cat(theta, ",")
```

but for brevity, our simulation only estimates the indices of $\theta$ in $\mathcal C =\{$ `r paste0(covts.record, "")`$\}$ elements of $\theta$. Accordingly, **all statistics and visuals are indicative of performance only on the set $\mathcal C$.**





```{r, eval=!compare.to.cgm & !compare.to.vdg, results='asis'}
cat("The results from our code are not augmented with any comparison method here.")
```

```{r, eval=compare.to.cgm & !compare.to.vdg, results='asis'}
cat("The results from our code are compared to those of [Cai, Guo, and Ma (2021)](http://www-stat.wharton.upenn.edu/~tcai/paper/Inference-GLM.pdf).")
```

```{r, eval=!compare.to.cgm & compare.to.vdg, results='asis'}
cat("The results from our code are compared to those of [van de Geer, Buhlmann, Ritov, and Dezeure (2014)](https://projecteuclid.org/journals/annals-of-statistics/volume-42/issue-3/On-asymptotically-optimal-confidence-regions-and-tests-for-high-dimensional/10.1214/14-AOS1221.full).")
```

```{r, eval=compare.to.cgm & compare.to.vdg, results='asis'}
cat("The results from our code are compared to those of both [Cai, Guo, and Ma (2021)](http://www-stat.wharton.upenn.edu/~tcai/paper/Inference-GLM.pdf) and [van de Geer, Buhlmann, Ritov, and Dezeure (2014)](https://projecteuclid.org/journals/annals-of-statistics/volume-42/issue-3/On-asymptotically-optimal-confidence-regions-and-tests-for-high-dimensional/10.1214/14-AOS1221.full).")
```

The attached results include the mean-squared error for each parameter estimate, as well as boxplots for a selection of nonzero and zero-valued parameters. In the boxplots, the green line represents the true value of the estimated parameter.

After these, I show coverage statistics for 95% symmetric confidence intervals for each of the parameters.

## Results


### Mean-squared error comparison $(\frac{1}{n.sim}\sum_{i=1}^{n.sim} \frac{1}{|\mathcal C|}\|\hat\theta_{i,\mathcal C}-\theta_{\mathcal C}\|^2)$

```{r}
results.env <- new_environment(list())
for(m in methods.detected){
  # env_bind(results.env, !!sym(paste0("results.hist.", m)) := env_get(.GlobalEnv, paste0("results.hist.", m)) )
    env_bind(results.env, !!sym(paste0("results.hist.", m)) := env_get(current_env(), paste0("results.hist.", m)) )
}
```

```{r}
sqe <- matrix(NA, nrow=length(covts.record)+1, ncol=length(results.env), dimnames = list(c(paste0("theta[", covts.record, "]"), 
"total"), methods.detected))

sqe.first.step = sqe

for(m in methods.detected){
  result = env_get(results.env, paste0("results.hist.", m) )
  sqe[-nrow(sqe),m] <- (result$value-matrix(theta[covts.record], nrow=length(covts.record), ncol=n.sim))^2 |> rowMeans()
  sqe[nrow(sqe),m] <- mean(sqe[-nrow(sqe),m])
  if(m != 'vdg'){
    sqe.first.step[-nrow(sqe),m] <- (result$first.step-matrix(theta[covts.record], nrow=length(covts.record), ncol=n.sim))^2 |> rowMeans()
    sqe.first.step[nrow(sqe),m] <- mean(sqe.first.step[-nrow(sqe),m])
  }
}

kable(sqe, digits=3, caption="Mean-Squared Error of Parameter Estimates")
kable(sqe.first.step, digits=3, caption="Mean-Squared Error of First-Step Parameter Estimates")
```



\newpage

```{r, results='asis', include=params$boxplot}
cat("### Boxplots")
```



```{r, fig.pos='b', eval=params$boxplot}
par(mfrow=c(1,length(methods.detected)))
for(i in covts.record){
  for(m in methods.detected){
    result = env_get(results.env, paste0("results.hist.", m) )
    hist(result$value[result$parameter.no==i,], freq = FALSE, main=paste0("Histogram of ", m, " estimates for theta[", i, "]=", theta[i]), cex.main=0.6, xlab=NULL)
    abline(v=theta[i], col='green', lty='dashed', lwd=2.5)
  }
}
```

\newpage

```{r, results='asis', eval=params$first.step}
cat("### First Step Histograms")
```

```{r, fig.pos='b', eval=params$boxplot & params$first.step}
par(mfrow=c(1,length(methods.detected)))
for(i in covts.record){
  for(m in methods.detected){
    result = env_get(results.env, paste0("results.hist.", m) )
    hist(result$first.step, freq = FALSE, main=paste0("Histogram of ", m, " first-step estimates for theta[", i, "]=", theta[i]), cex.main=0.5, xlab=NULL)
    abline(v=theta[i], col='green', lty='dashed', lwd=2.5)
  }
}
```

\newpage

### Statistics and 95% Confidence Intervals from per-Replicate Estimates

```{r, eval=params$bootstrap, results='asis'}
out = list()
for(m in methods.detected){
  result = env_get(results.env, paste0('results.hist.', m))
  env_bind(.GlobalEnv, !!sym(paste0("df.out.", m)) := data.frame())
}

for(m in methods.detected){
    result = env_get(results.env, paste0('results.hist.', m))
    result.df = env_get(.GlobalEnv, paste0('df.out.', m))
for(i in seq_along(covts.record)){
    result.augment = data.frame(Min = min(result$value[i,]), Median = median(result$value[i,]), Max = max(result$value[i,]), lower.CI.btsp=quantile(result$value[i,],0.025), upper.CI.btsp=quantile(result$value[i,],0.975))
    if(i==1) result.df = result.augment else result.df = rbind(result.df, result.augment)
  }
  rownames(result.df) = paste0("theta[", covts.record, "]")
  out = list_append(out, kable(result.df, digits=3, caption=paste0("Bootstrap Statistics for ", m, " Estimates") ) )
  kable(result.df, digits=3, caption=paste0("Statistics for ", m, " Estimates") ) |> print()
}
```

\vspace{5pt}

### Statistics for Theoretical 95% Confidence Intervals

```{r, eval=params$ci, results='asis'}
for(m in methods.detected){
  result = env_get(results.env, paste0('results.hist.', m))
  env_bind(.GlobalEnv, !!sym(paste0("df.out.", m)) := data.frame())
}

for(m in methods.detected){
    result = env_get(results.env, paste0('results.hist.', m))
    result.df = env_get(.GlobalEnv, paste0('df.out.', m))
for(i in seq_along(covts.record)){
    result.augment = data.frame(Estimate = mean(result$value[i,]), SE = mean(result$se[i,]), lower.CI=mean(result$ci[i,,'lower']), upper.CI=mean(result$ci[i,,'upper']), cvg  = mean( (result$ci[i,,'lower'] <= theta[covts.record[i]]) & (theta[covts.record[i]] <= result$ci[i,,'upper']) ) )
    if(i==1) result.df = result.augment else result.df = rbind(result.df, result.augment)
  }
  rownames(result.df) = paste0("theta[", covts.record, "]")
  kable(result.df, digits=3, caption = paste0("Theoretical 95% Confidence Interval Statistics (averaged across replications) for ", m, " Estimates")) |> print()
}
```